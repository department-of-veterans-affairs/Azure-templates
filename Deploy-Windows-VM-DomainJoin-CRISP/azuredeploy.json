{
"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
"contentVersion": "1.0.0.0",
"parameters": {
    "location": {
        "type": "string",
        "allowedValues":
        [
            "usgovvirginia",            
            "usgovtexas",
            "usgovarizona"
        ]
    },
    "vmName": {
        "type": "string"
    },
    "vmSize": {
        "type": "string",
        "defaultValue": "Standard_D2_v2"
    },
    "vmAdminUsername": {
        "type": "string"
    },
    "vmAdminPassword": {
        "type": "securestring"
    },
    "ouPath": {
        "type": "string",        
        "metadata": {
        "description": "For Example: OU=ProjectXYZ,OU=Servers,DC=DOMAIN,DC=GOV"
        }
    },
    "keyVaultName": {
        "type": "string",        
        "metadata": {}
    },
    "keyVaultSecretName": {
        "type": "string",
        "metadata": {}
    },
    "keyVaultResourceGroupName": {
        "type": "string",
        "metadata": {}
    },
    "domainUserName": {
        "type": "string",
        "metadata": {}
    },
    "domainToJoin": {
        "type": "string",
        "metadata": {}
    },   
    "crispComponentURI": {
        "type": "string",
        "metadata": {}
    },
    "provisioningScriptURI": {
        "type": "string",
        "metadata": {}
    },
    "domainGroupToAdd": {
        "type": "string",
        "metadata": {}
    },
    "numberOfServersToDeploy": {
        "type": "int",
        "metadata": {}
    },
    "vmStartInstancePrefix": {
        "type": "int",
        "defaultValue": "1"
    },
    "subnetName": {
        "type": "string",
        "metadata": {}
    },
    "existingVNETName":{
        "type": "string",
        "metadata": {}
    },
    "existingVNETResourceGroupName": {
        "type": "string",
        "metadata": {}
    },
    "windowsOSVersion": {
        "type": "string",
        "metadata": {},
        "allowedValues":
        [
          "2012-R2-Datacenter",
          "2016-Datacenter"
        ]
      },        
    "osDiskStorageType": {
        "type": "string",
        "metadata": {},
        "allowedValues": [
            "Standard_LRS",
            "Premium_LRS"
        ]
    }    
},
    "variables": {                  
      "domainJoinOptions": "3",
      "keyVaultRef": "[concat('/subscriptions/', 'a682391d-f87e-4d37-83ff-91e1620f3c8a', '/resourceGroups/', parameters('keyVaultResourceGroupName'), '/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]",
      "provisioningScriptFolder": ".",
      "provisioningScriptFileName": "VMProvisioningScript.ps1",
      "vnetRef": "[resourceId(subscription().subscriptionId, parameters('existingVNETResourceGroupName'),'Microsoft.Network/virtualNetworks',parameters('existingVNETName'))]",     
      "subnetRef": "[concat(variables('vnetRef'), '/subnets/', parameters('subnetName'))]",
      "domainPassword":
            {
                "reference": {
                    "keyVault": {
                      "id": "[variables('keyVaultRef')]"
                    },
                    "secretName": "[parameters('keyVaultSecretName')]"
                  }
            }        
    },
    "resources":
    [
        {
         "name": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '_NIC')]",
         "type": "Microsoft.Network/networkInterfaces",
         "location": "[parameters('location')]",
         "apiVersion": "2016-03-30",
         "dependsOn": [],
         "copy": {
              "name": "nicLoop",
              "count": "[parameters('numberOfServersToDeploy')]"
            },
         "properties":
         {
           "ipConfigurations":
            [
              {
               "name": "ipconfig1",
               "properties":
                {
                 "privateIPAllocationMethod": "Dynamic",                
                 "subnet":
                 {
                   "id": "[variables('subnetRef')]"
                 }
                }
              }
            ]
           }
        },
        {
            "apiVersion": "2016-04-30-preview",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()))]",
            "location": "[parameters('location')]",
            "dependsOn": [
              "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '_NIC')]"
            ],
            "copy": {
              "name": "vmLoop",
              "count": "[parameters('numberOfServersToDeploy')]"
          },
            "tags":
            {
              "displayName": "VirtualMachine"
            },
            "properties":
            {
              "hardwareProfile":
              {
                "vmSize": "[parameters('vmSize')]"
              },
              "osProfile":
              {
                "computerName": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()))]",
                "adminUsername": "[parameters('vmAdminUsername')]",
                "adminPassword": "[parameters('vmAdminPassword')]",
                "windowsConfiguration":
                {
                  "timeZone": "Central Standard Time",
                  "provisionVMAgent": true
                }
              },
              "storageProfile":
              {
                "imageReference":
                {
                  "publisher": "MicrosoftWindowsServer",
                  "offer": "WindowsServer",
                  "sku": "[parameters('windowsOSVersion')]",
                  "version": "latest"
                },
                "osDisk":
                {
                  "name": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '_OSdisk')]",
                  "managedDisk":
                  {
                    "storageAccountType": "[parameters('osDiskStorageType')]"
                  },
                  "caching": "ReadWrite",
                  "createOption": "FromImage"
                }          
              },
              "networkProfile":
              {
                "networkInterfaces":
                [
                  {
                    "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '_NIC'))]"
                  }
                ]
              }        
            },
            "resources":[
            {
              "apiVersion": "2016-04-30-preview",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "name": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '/joindomain')]",
              "location": "[parameters('location')]",
              "dependsOn":
              [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()))]"        
              ],
              "tags":
              {
                "displayName": "JsonADDomainExtension"
              },
              "properties":
              {
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings":
                {
                  "Name": "[parameters('domainToJoin')]",
                  "OUPath": "[parameters('ouPath')]",
                  "User": "[concat(parameters('domainToJoin'), '\\', parameters('domainUsername'))]",
                  "Restart": "false",
                  "Options": "[parameters('domainJoinOptions')]"
                },
                "protectedSettings":
                {
                  "Password": "[parameters('domainPassword')]"
                }
              }
            },
            {
              "name": "[concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()), '/ProvisionVM')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "location": "[parameters('location')]",
              "apiVersion": "2017-12-01",
              "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex()))]",
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('vmName'), add(parameters('vmStartInstancePrefix'), copyIndex())), 'joindomain')]"
               ],
              "tags": {
                "displayName": "Install CRISP Components"
              },
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.4",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "fileUris": [
                    "[parameters('provisioningScriptURL')]"
                  ],
                  "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ', parameters('provisioningScriptFolder'), '/', parameters('provisioningScriptFileName'), ' ', '\"', parameters('crispComponentURI'),'\"', ' ', parameters('domainGroupToAdd'))]"
                }
              }
            }
          ]
        }                   
    ],
    "outputs":
    {
  
    }
  }
